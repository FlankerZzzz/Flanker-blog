# MoviePilot 安装部署
## 一、我的部署架构与实现的功能
1. 部署方式：在群晖内采用docker方式部署
2. 配套服务：媒体server为Jellyfin，下载器为qBittorrent，加一台科学上网代理，加一台公网nginx做双向反向代理(后面详细介绍)
3. 实现功能：
  - 3.1：MP web端可以正常搜索，下载，整理入库
  - 3.2：微信交互，可以正常搜索，下载，整理入库
  - 3.3：基于插件的自动监控下载目录，并实现自动化入库
  - 3.4：基于插件的站点自动登录、签到
  - 3.5：基于iyuu插件的辅种  
上面这几点，应该已经覆盖大多数用户的使用场景了，下面进行详细解释，配置方法均为群晖docker的配置方法，如果你自己写compose灵活修改即可

## 二、群晖内docker方式部署配置
我这里还是以群晖为视角，基础操作不表，群晖docker套件内先拉取mp镜像，然后开始配置mp容器  
首先是资源限制，CPU和内存这个自己按照情况选择即可，自启动可以勾上  

### 网络和权限
先说网络模式和是否选择高权限执行容器，根据官方wiki如下
> https://wiki.movie-pilot.org/zh/install  

权限部分：我们可以看到，官方安装yml内采用了uid、gid为0，umake为000的高权限配置，故我这里也选择**高权限执行容器**  
网络部分：官方为bridge模式，bridge模式下需要手动绑定端口，根据官方配置映射我们可以得知只需要将web ui也就是默认3000的端口对外暴露即可，这里再次解释下这里的逻辑  
1. 首先环境变量内'NGINX_PORT'值决定了内部ng将服务打在哪个端口上，默认为三千，可以自行更改
2. 默认yml中，将内部3000端口映射到外部3000端口，即外部3000端口的访问等于直接访问mp的web界面
3. 如果你的nas是全端口暴露或者dmz的，切记不要用默认端口，可以更改为'其他端口':'3000'，也可以修改'NGINX_PORT'值，然后重新映射'任意端口':'NGINX_PORT'值  

我为了便于调试，网络模式为host，host就相当于和宿主机网络环境一致，所有对外端口都会打在宿主机上，除非你知道自己要做什么，否则不要开host模式  

---
### 环境变量和文件映射

#### 环境变量
NGINX_PORT、PUID、PGID、UMASK，这些都解释过了，也不用调整按照默认即可

|变量|值|备注|
|----|---|---|
|PORT|3001|不冲突重复即可，可自行修改，不能与WEB服务端口冲突|
|PROXY_HOST||代理，强烈建议有条件的使用代理
|MOVIEPILOT_AUTO_UPDATE||控制mp的自动升级（github），release和true即可，效果一样
|AUTH_SITE|hdfans|认证站点，这里举例红豆饭|
|HDFANS_UID| |红豆饭UID|
|HDFANS_PASSKEY| |红豆饭passkey|

> 要注意，mp是需要PT站点认证的（认证和添加站点无关，认证这个站点不代表添加这个站点，但是要添加任何站点都必须先认证），具体支持哪些官网wiki有写  
当我们想好要配置哪个站点的认证的时候，那么实际上有三个变量需要填写
AUTH_SIT告诉mp使用什么站点，HDFANS_UID红豆饭的认证格式，HDFANS_PASSKEY红豆饭passkey  
#### 文件挂载
挂载点|作用|
|-----|----|
|/moviepilot/config|配置文件落地位置，这个非常重要必须映射|
|/moviepilot/core| 官方解释：为浏览器内核下载保存目录（避免容器重置后重新下载浏览器内核），需根据实际情况调整。|
|/var/run/docker.sock|这个是不映射会影响内部重启那个按钮，群晖docker部署的话可能映射不上，问题不大|
|/media/|见官网解释把，这里想说的是并不是/media必须作为媒体库，其他路径你自行映射也是可以的，强调这一点是因为后续qbit触发下载的时候需要路径和外面一致，如果你映射路径和外部路径不一致的话qbit无法触发下载（因为下载路径不存在），这里不理解的话，自行摸索一下把|

> 上面就是主要的文件挂载点了，并没有很复杂很难理解  
挂载和环境变量，还有网络以及服务打在什么端口都搞清楚后，启动容器后你应该可以正常进入mp的web界面了，并且docker日志内应该看到pt站点认证成功，要注意第一次登陆的默认密码也在docker日志内，是一串强密码，请自行查找  

## 三、MP内配置与业务逻辑详解
下面在分析下MP内我们需要进行哪些配置和他的业务逻辑到底是怎样的  
从简单的开始说

### 下载器与媒体服务器
设定->连接->按照页面提示与你实际情况填写即可，记得区分http和https，还有端口号  
例如一个正确的地址应该为http://192.168.31.1:28085

> 解释几个疑难点：  
1. 每一项配置模块，都有单独的保存按钮，且每个模块不仅需要配置，而且需要选中才会生效
2. Jellyfin、emby的api，自行去控制台->高级->api密钥进行创建并复制
3. “外网播放地址”，其实就是你在mp内首页媒体里面点击后，跳转播放的地址，如果你有外网和ddns地址可以写上
4. 关于下载器中“下载文件自动整理按钮”我并未开启这个功能，因为我通过插件“目录监控”来实现自动整理了，所以这个功能我不清楚具体执行逻辑，官网wiki内也没有看到更详细的介绍  
### 站点配置与cookiecloud浏览器插件
> 先明确概念  
1. cookiecloud在mp体系内的作用为，抓取浏览器内的相关cookie（和其他相关信息），提供给mp以便mp内自动添加并识别站点
2. 在目前新版本中，mp内建了cookiecloud服务器，所以无需将数据提交至其他公共服务器做转发
3. 站点也可以手动添加，且部分不能自动添加的站点也必须手动添加（如，需要token的馒头）
4. cookiecloud是一个浏览器插件，主流浏览器都能装，链接在这，自行部署到浏览器中  
https://github.com/easychen/CookieCloud/releases

明确了这些，我们可以进行下一步配置

> 插件内设置
- 插件里服务器地址填写mp内地址，http://localhost:3000/cookiecloud  
http://mp地址:你的mp访问端口/cookiecloud
- 插件会自动生成“用户KEY · UUID”、“端对端加密密码”
- 可以把不想同步的站点添加到黑名单中，例如“google.com”
- 插件内可以点击测试，如成功，则成功。。。
- 其他配置可以不动，如果有修改可以点击保存，手动同步则为手动同步字面意思。。。

> MP内设置
- 生成的“用户KEY · UUID”、“端对端加密密码”，请一字不差复制到mp中
- 浏览器UA应该会自动获取
- mp内记得保存

这些配置完毕后，点击一次手动同步，mp内设定->站点->拉到最下方，删除所有站点并重新同步  
观察下“站点管理”里面是不是有你的站点同步上来

> 馒头的添加方法：手动添加，填写站点地址、rss、请求头和UA，cookie不写，填apikey，去馒头控制台->实验室里面建立存取令牌，并复制过来，切记这个令牌妥善保管不要泄露

### 下载目录与媒体库目录
还是先说概念和逻辑
1. 下载目录是qbit的下载目录，媒体库目录是jellyfin需要映射的目录，两者路径不同（当然你直接往jellyfin媒体目录下下载也不是不行）
2. 在我的使用场景下，或者说通常场景下，下载目录内的文件，需要经过一次“整理”，“转换”到媒体目录下
3. 这里的整理，只是对文件、文件夹进行编排和重命名，不涉及刮削
4. 这里的转换，可以有很多种方式，硬链接、软连接、复制、移动
5. 复制和移动就是字面意思，这里不推荐使用，当然如果符合你的使用场景就无所谓
6. 硬链接软链接，如果你不是计算机工作者，不需要了解太过于深入，只需要按照你的场景去考虑即可，如果你下载目录和媒体库目录不在一个硬盘上，那么只能使用软链接，软链接约等于windows下的快捷方式，硬链接则必须为同一个硬盘内，硬链接的原理是新建一个索引入口指向同一个inode

>热心群友：inode可以理解为一个文件的meta信息，写在ext格式的文件头，占一定的容量
os读取文件的底层步骤是：用户态 -> path -> 内核态 -> 获取inode信息 -> 获取硬盘block信息 -> 从block读取字节流  

>热心群友：就是原文件你加了个硬链接现在就是两个入口指向一个inode了嘛，然后你干掉其中任意一个是不会删除这个inode本身的，所有入口索引都干掉，inode就删除了  
如果你觉得这样的操作违反直觉的话就软链接好了，当快捷方式用
---
下载目录和媒体库目录都可以设置多个，并可以设置大分类电影、电视剧，qbit触发下载会自动放置到对应的大文件夹中  
“自动分类”则是在上述最大一级（电影、电视剧）下在自动根据媒体类型建立子库，如“外国电影”、“华语电影”或者“国产剧”、“欧美剧”等类型，开或者不开都行，毕竟这是整理前的文件夹，无需过度计较，媒体库目录下的“自动分类”同理  

下载触发方式为，从首页搜索菜单中搜索你的资源，第一次搜索会检索tmdb或者豆瓣，明确资源后再点击搜索资源才会触发你添加的PT站点内的搜索，然后再次点击搜索结果内某一资源才能触发下载

整理方式为设置>连接>下载器>下载文件自动整理  
~~如果一切顺利的话，目前你已经可以成功搜索，触发下载，下载到指定下载目录了，那么下载目录和媒体库目录的“转换”，也就是整理工作，我推荐使用插件“目录监控”来实现~~ 


~~格式为：  
监控目录:整理到哪个媒体库目录#整理模式（软硬链接等），例如我的配置是~~
> ~~/volume3/Node_影音库/bt/电影:/volume3/Node_影音库/影片/电影#softlink  
/volume3/Node_影音库/bt/电视剧:/volume3/Node_影音库/影片/电视剧#softlin~~

如果一切正确，你在Jellyfin中扫描一下媒体库就可以看到新的电影了，那么mp web端的配置就已经结束了，这就是整个mp的自动下载的交互流程
1. 用户搜索>检索tmdb和豆瓣>确定资源>触发下一级PT站内搜索
2. PT站内搜索结果>点击触发下载>调用qbit或tr
3. qbit、tr接管下载>下载到mp指定的下载目录，如果有分类则自动分类
4. ~~目录监控插件~~设置>连接>下载器>下载文件自动整理，~~接管发现下载目录有新文件~~下载完毕后自动整理>根据配置触发整理>整理到指定的媒体库目录（如需刮削则刮削）
5. 媒体server接管，根据配置刮削，并正式入库

## 四、微信（企业微信）交互
这一部分可能是难度最高的，我还是先介绍逻辑
1. 这里的微信交互实际还是为企业微信交互，在企业微信内添加插件到普通微信，这样普通微信也可以调用这个交互接口，而无需企业微信客户端
2. 企业微信交互最大痛点在于，必须配置可信的固定IP，如果你是家宽公网通常是动态的，他可能伴随你的一些操作比如重新拨号或者猫重启会导致IP改变，IP改变后企业微信识别到陌生IP则无法交互，实时手动去微信后台更改这个可信IP可以满足需求但是通常来说不是可以接受的方案
3. 我假定你能理解上面我说的内容，并且家庭内已经拥有动态公网IP和DDNS域名，那么解决方案就是在固定公网下部署一台nginx做双向反代

> 交互拓扑  

<img src="https://github.com/FlankerZzzz/Flanker-blog/blob/main/MoviePilot%E7%9A%84%E9%83%A8%E7%BD%B2/test.png">
从逻辑上来说，我给mp发消息，mp给我发消息都需要经过中间节点nginx的双向反代，下面上ng配置

```shell
    server {
        listen       12345; #nginx入端口
        server_name  localhost;

        resolver 114.114.114.114 valid=5s; #手动强制DNS解析 并有效期5s
        set $flanker http://domain:port; #ddns域名
        location /api/v1/message/ {
         proxy_pass $flanker;  
}
        location /cgi-bin/gettoken {
          proxy_pass https://qyapi.weixin.qq.com;
}                            
        location /cgi-bin/message/send {
          proxy_pass https://qyapi.weixin.qq.com;
}
        location  /cgi-bin/menu/create {
          proxy_pass https://qyapi.weixin.qq.com;
}
```
解释：当用户发送消息时，企微服务器会将消息发送到http://nginx:12345/api/v1/message/ 这个接口上  
Nginx接到请求后转发至http://domain:port/api/v1/message/ 也就是mp的消息接口  
MP发起搜索，返回结果，发送消息  
http://nginx:12345/cgi-bin/gettoken ng转发https://qyapi.weixin.qq.com/cgi-bin/gettoken  
http://nginx:12345/cgi-bin/message/send ng转发https://qyapi.weixin.qq.com/cgi-bin/message/send  
http://nginx:12345/cgi-bin/menu/create ng转发https://qyapi.weixin.qq.com/cgi-bin/menu/create  

写不动了。。企微配置，将对应的信息填入mp通知配置里，代理地址为http://nginx:12345
企业微信创建应用，把nginx地址添加到企业可信IP，api接收消息里配置 http://nginx:12345/api/v1/message/，Token和EncodingAESKey填到对应mp配置里面

> 关于DDNS在nginx里的配置，我查阅资料发现，nginx只会在初次运行时进行一次解析，如果nginx运行过程当中ddns对应地址发生改变，nginx无法自动更新解析，所以在配置时指定 resolver 不一定要用114，选你连通性好的即可，这个配置我已经测试很多次了，很完美
[root@TXyun-Flanker nginx]# ./sbin/nginx -v
nginx version: nginx/1.27.0
